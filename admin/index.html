<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="UTF-8" />
    <title>Content Manager Debug</title>
    <style>
      body {
        font-family: system-ui, sans-serif;
        padding: 2rem;
        background: #f5f5f5;
      }
      .log {
        background: #1e1e1e;
        color: #0f0;
        padding: 1rem;
        margin-top: 2rem;
        font-family: monospace;
        font-size: 0.9rem;
        white-space: pre-wrap;
        overflow-x: auto;
        border-radius: 5px;
      }
    </style>
    <script>
      window.CMS_MANUAL_INIT = true;
    </script>
    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
    <script src="https://unpkg.com/netlify-cms@^2.10.0/dist/netlify-cms.js"></script>
  </head>
  <body>
    <h1>🚀 CMS 除錯模式啟動</h1>
    <div id="output" class="log">啟動中...</div>

    <script>
      const log = (...args) => {
        const out = document.getElementById('output');
        out.textContent += '\n' + args.map(x => (typeof x === 'object' ? JSON.stringify(x, null, 2) : x)).join(' ');
        console.log(...args);
      };

      const showError = (msg) => {
        const out = document.getElementById('output');
        out.style.color = '#f00';
        out.style.background = '#111';
        out.textContent += '\n\n❌ 錯誤：' + msg;
      };

      log('🟡 啟動 Netlify CMS 除錯...');

      if (window.netlifyIdentity) {
        window.netlifyIdentity.on('init', (user) => {
          log('🔍 Netlify Identity 初始化完成：', user);

          if (!user) {
            log('🔐 尚未登入，等待使用者登入...');
            window.netlifyIdentity.on('login', () => {
              log('✅ 使用者登入成功，重新載入 CMS...');
              window.location.reload();
            });
          } else {
            log('✅ 使用者已登入');
          }
        });
        window.netlifyIdentity.init();
      } else {
        showError('⚠️ 找不到 netlifyIdentity，請確認身份驗證元件是否加載成功');
      }

      // 嘗試讀取 Git Gateway 使用者資料
      fetch('/.netlify/git/github/user')
        .then(r => {
          if (!r.ok) {
            throw new Error(`Git Gateway 回應錯誤：${r.status} ${r.statusText}`);
          }
          return r.json();
        })
        .then(data => {
          log('🔁 Git Gateway 使用者：', data);
        })
        .catch(err => {
          showError('Git Gateway 使用者讀取失敗 → ' + err.message);
        });

      // 載入 config.json 並初始化 CMS
      fetch('config.json')
        .then((response) => {
          if (!response.ok) {
            throw new Error(`無法讀取 config.json：${response.status}`);
          }
          return response.json();
        })
        .then((config) => {
          log('⚙️ CMS 配置讀取成功：', config);
          CMS.init({ config });

          CMS.registerEventListener({
            name: '*',
            handler: ({ name, payload }) => {
              log(`📦 CMS Event - ${name}`, payload);
            },
          });
        })
        .catch((err) => {
          showError('CMS 初始化失敗 → ' + err.message);
        });
    </script>
  </body>
</html>
