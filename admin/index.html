<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="UTF-8" />
    <title>Content Manager Debug</title>
    <style>
      body {
        font-family: system-ui, sans-serif;
        padding: 2rem;
        background: #f5f5f5;
      }
      .log {
        background: #1e1e1e;
        color: #0f0;
        padding: 1rem;
        margin-top: 2rem;
        font-family: monospace;
        font-size: 0.9rem;
        white-space: pre-wrap;
        overflow-x: auto;
        border-radius: 5px;
      }
    </style>
    <script>
      window.CMS_MANUAL_INIT = true;
    </script>
    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
    <script src="https://unpkg.com/netlify-cms@^2.10.0/dist/netlify-cms.js"></script>
  </head>
  <body>
    <h1>ğŸš€ CMS é™¤éŒ¯æ¨¡å¼å•Ÿå‹•</h1>
    <div id="output" class="log">å•Ÿå‹•ä¸­...</div>

    <script>
      const log = (...args) => {
        const out = document.getElementById('output');
        out.textContent += '\n' + args.map(x => (typeof x === 'object' ? JSON.stringify(x, null, 2) : x)).join(' ');
        console.log(...args);
      };

      const showError = (msg) => {
        const out = document.getElementById('output');
        out.style.color = '#f00';
        out.style.background = '#111';
        out.textContent += '\n\nâŒ éŒ¯èª¤ï¼š' + msg;
      };

      log('ğŸŸ¡ å•Ÿå‹• Netlify CMS é™¤éŒ¯...');

      if (window.netlifyIdentity) {
        window.netlifyIdentity.on('init', (user) => {
          log('ğŸ” Netlify Identity åˆå§‹åŒ–å®Œæˆï¼š', user);

          if (!user) {
            log('ğŸ” å°šæœªç™»å…¥ï¼Œç­‰å¾…ä½¿ç”¨è€…ç™»å…¥...');
            window.netlifyIdentity.on('login', () => {
              log('âœ… ä½¿ç”¨è€…ç™»å…¥æˆåŠŸï¼Œé‡æ–°è¼‰å…¥ CMS...');
              window.location.reload();
            });
          } else {
            log('âœ… ä½¿ç”¨è€…å·²ç™»å…¥');
          }
        });
        window.netlifyIdentity.init();
      } else {
        showError('âš ï¸ æ‰¾ä¸åˆ° netlifyIdentityï¼Œè«‹ç¢ºèªèº«ä»½é©—è­‰å…ƒä»¶æ˜¯å¦åŠ è¼‰æˆåŠŸ');
      }

      // å˜—è©¦è®€å– Git Gateway ä½¿ç”¨è€…è³‡æ–™
      fetch('/.netlify/git/github/user')
        .then(r => {
          if (!r.ok) {
            throw new Error(`Git Gateway å›æ‡‰éŒ¯èª¤ï¼š${r.status} ${r.statusText}`);
          }
          return r.json();
        })
        .then(data => {
          log('ğŸ” Git Gateway ä½¿ç”¨è€…ï¼š', data);
        })
        .catch(err => {
          showError('Git Gateway ä½¿ç”¨è€…è®€å–å¤±æ•— â†’ ' + err.message);
        });

      // è¼‰å…¥ config.json ä¸¦åˆå§‹åŒ– CMS
      fetch('config.json')
        .then((response) => {
          if (!response.ok) {
            throw new Error(`ç„¡æ³•è®€å– config.jsonï¼š${response.status}`);
          }
          return response.json();
        })
        .then((config) => {
          log('âš™ï¸ CMS é…ç½®è®€å–æˆåŠŸï¼š', config);
          CMS.init({ config });

          CMS.registerEventListener({
            name: '*',
            handler: ({ name, payload }) => {
              log(`ğŸ“¦ CMS Event - ${name}`, payload);
            },
          });
        })
        .catch((err) => {
          showError('CMS åˆå§‹åŒ–å¤±æ•— â†’ ' + err.message);
        });
    </script>
  </body>
</html>
