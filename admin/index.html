<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Content Manager</title>
    <!-- 1) 先告诉 CMS：等我手动初始化 -->
    <script>window.CMS_MANUAL_INIT = true;</script>
    <!-- 2) 加载 Netlify Identity Widget -->
    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
    <!-- 3) 再载入 Netlify-CMS 核心脚本 -->
    <script src="https://unpkg.com/netlify-cms@^2.10.0/dist/netlify-cms.js"></script>
  </head>
  <body>
    <script>
      // —— 手动初始化逻辑 —— //

      if (window.netlifyIdentity) {
        // 先初始化 Identity Widget，监听 init 事件
        window.netlifyIdentity.on('init', user => {
          if (user) {
            // 如果已经登录，直接加载并启动 CMS
            loadAndInitCMS();
          }
        });

        // 监听登录成功事件
        window.netlifyIdentity.on('login', () => {
          // 关闭登录对话框
          window.netlifyIdentity.close();
          // 登录后加载并启动 CMS
          loadAndInitCMS();
        });

        // 真正启动 Identity Widget
        window.netlifyIdentity.init();
      }

      /**
       * 加载 config.json 并初始化 Netlify CMS
       */
      function loadAndInitCMS() {
        fetch('config.json')
          .then(response => {
            if (!response.ok) {
              throw new Error(`Could not load config.json: ${response.status}`);
            }
            return response.json();
          })
          .then(config => {
            CMS.init({ config });
          })
          .catch(err => {
            console.error('Config load error:', err);
            document.body.innerHTML =
              '<h1 style="color:red; text-align:center; margin-top:2rem;">CMS 配置载入失败</h1>' +
              `<pre style="color:red; text-align:center;">${err.message}</pre>`;
          });
      }
    </script>
  </body>
</html>
