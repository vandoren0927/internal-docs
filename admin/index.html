<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>多文件上傳工具</title>
  <style>
    /* ...同上面美化样式... */
  </style>
</head>
<body>
  <div class="container">
    <h1>多文件上傳工具</h1>
    <form id="uploadForm">
      <label>選擇檔案 (.md, .png, .jpg, .gif, .mp4):<br>
        <input type="file" name="file"
               accept=".md,.png,.jpg,.jpeg,.gif,.mp4" required>
      </label>
      <label>上傳到子資料夾 (可留空):<br>
        <input type="text" name="targetPath"
               placeholder="例如 guides/intro">
      </label>
      <button type="submit">上傳到 GitHub</button>
    </form>
    <pre id="result"></pre>
  </div>

  <script>
    document.getElementById('uploadForm').addEventListener('submit', async e => {
      e.preventDefault();
      const form = e.currentTarget;
      const file = form.file.files[0];
      const targetPath = form.targetPath.value.trim();
      const result = document.getElementById('result');
      result.textContent = '上傳中…';
      if (!file) return;

      // 讀文件並 base64
      const contentBase64 = await new Promise(res => {
        const reader = new FileReader();
        reader.onload = () => res(btoa(reader.result));
        reader.readAsBinaryString(file);
      });

      let json;
      try {
        const resp = await fetch('/.netlify/functions/upload-md', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ fileName: file.name, contentBase64, targetPath })
        });
        // 试着解析 JSON
        const text = await resp.text();
        try {
          json = JSON.parse(text);
        } catch {
          throw new Error(`Server 非 JSON 回應：${text}`);
        }

        if (resp.ok && json.ok) {
          result.textContent = `✅ 上傳成功！路徑：${json.path}`;
        } else {
          throw new Error(json.error || `狀態碼 ${resp.status}`);
        }
      } catch (err) {
        result.textContent = `❌ 上傳失敗：${err.message}`;
        console.error(err);
      }
    });
  </script>
</body>
</html>
